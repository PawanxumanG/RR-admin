
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RR College Admin - Live Notice Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #e6edf3;
            margin: 0;
            overflow-x: hidden;
        }
        .glass-panel {
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(48, 54, 61, 1);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #0d1117;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 10px;
        }
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 3s infinite ease-in-out;
        }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "@google/genai": "https://esm.sh/@google/genai@1.34.0",
        "htm": "https://esm.sh/htm@3.1.1"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenAI } from "@google/genai";
        import htm from 'htm';

        const html = htm.bind(React.createElement);

        // --- Services ---
        
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY || '' });

        const refineNotice = async (title, message, tone) => {
            try {
                const response = await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: `You are an expert communications officer for RR International College. 
                    I have a notice title: "${title}" and message: "${message}".
                    Please rewrite this to be ${tone}. 
                    Keep it professional but engaging. 
                    Return only the rewritten message text, no conversational filler or markdown code blocks.`,
                });
                return response.text || message;
            } catch (error) {
                console.error("Gemini refinement error:", error);
                throw error;
            }
        };

        const githubService = {
            async fetchFile(config) {
                const { owner, repo, path, token } = config;
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (!response.ok) throw new Error(`Fetch failed: ${response.statusText}`);
                const data = await response.json();
                return {
                    content: JSON.parse(atob(data.content)),
                    sha: data.sha
                };
            },
            async updateFile(config, announcement, sha) {
                const { owner, repo, path, token } = config;
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                const contentBase64 = btoa(JSON.stringify(announcement, null, 2));
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Notice Update: ${announcement.title}`,
                        content: contentBase64,
                        sha: sha
                    })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Update failed');
                }
                return await response.json();
            }
        };

        // --- Components ---

        const App = () => {
            const [config, setConfig] = useState(() => {
                const saved = localStorage.getItem('rr_admin_config_v2');
                return saved ? JSON.parse(saved) : { token: '', owner: '', repo: '', path: 'announcement.json' };
            });

            const [announcement, setAnnouncement] = useState({
                id: 'notice-default',
                show: false,
                title: '',
                message: ''
            });

            const [currentSha, setCurrentSha] = useState(null);
            const [loading, setLoading] = useState(false);
            const [isRefining, setIsRefining] = useState(false);
            const [status, setStatus] = useState(null);
            const [showSettings, setShowSettings] = useState(false);

            useEffect(() => {
                localStorage.setItem('rr_admin_config_v2', JSON.stringify(config));
            }, [config]);

            const notify = (type, message) => {
                setStatus({ type, message });
                setTimeout(() => setStatus(null), 4000);
            };

            const handleFetch = async () => {
                if (!config.token || !config.owner || !config.repo) {
                    notify('error', 'Please configure GitHub settings first.');
                    setShowSettings(true);
                    return;
                }
                setLoading(true);
                try {
                    const { content, sha } = await githubService.fetchFile(config);
                    setAnnouncement(content);
                    setCurrentSha(sha);
                    notify('success', 'Live notice data fetched successfully.');
                } catch (err) {
                    notify('error', err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleSave = async () => {
                if (!config.token || !currentSha) {
                    notify('error', 'Fetch latest data before saving changes.');
                    return;
                }
                setLoading(true);
                try {
                    const updated = { ...announcement, id: 'notice-' + Date.now() };
                    await githubService.updateFile(config, updated, currentSha);
                    notify('success', 'Published! Changes are now live.');
                    await handleFetch(); 
                } catch (err) {
                    notify('error', err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleAIPolish = async (tone) => {
                if (!announcement.title || !announcement.message) {
                    notify('error', 'Enter content before refining.');
                    return;
                }
                setIsRefining(true);
                try {
                    const result = await refineNotice(announcement.title, announcement.message, tone);
                    setAnnouncement(prev => ({ ...prev, message: result }));
                    notify('success', `Content polished to ${tone} tone.`);
                } catch (err) {
                    notify('error', 'AI refinement failed.');
                } finally {
                    setIsRefining(false);
                }
            };

            return html`
                <div className="min-h-screen p-4 md:p-10 flex flex-col gap-8 max-w-6xl mx-auto">
                    <!-- Header -->
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-b border-slate-800 pb-8">
                        <div>
                            <h1 className="text-4xl font-black text-white tracking-tight flex items-center gap-3">
                                <span className="bg-orange-600 w-3 h-10 rounded-full block"></span>
                                RR College Admin
                            </h1>
                            <p className="text-slate-500 font-medium mt-1">Live Noticeboard Control System</p>
                        </div>
                        <div className="flex gap-3">
                            <button 
                                onClick=${() => setShowSettings(!showSettings)}
                                className="px-5 py-2.5 bg-slate-800 hover:bg-slate-700 rounded-xl text-sm font-bold border border-slate-700 transition-all flex items-center gap-2"
                            >
                                ‚öôÔ∏è Settings
                            </button>
                            <button 
                                onClick=${handleFetch}
                                disabled=${loading}
                                className="px-5 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-xl text-sm font-bold shadow-lg shadow-blue-900/20 transition-all flex items-center gap-2 disabled:opacity-50"
                            >
                                ${loading ? '‚è≥' : 'üîÑ'} Sync Live
                            </button>
                        </div>
                    </header>

                    <!-- Notifications -->
                    ${status && html`
                        <div className=${`fixed top-6 right-6 z-50 p-4 rounded-2xl border shadow-2xl flex items-center gap-3 animate-bounce-in ${
                            status.type === 'success' ? 'bg-green-900/20 border-green-500/50 text-green-400' :
                            status.type === 'error' ? 'bg-red-900/20 border-red-500/50 text-red-400' :
                            'bg-blue-900/20 border-blue-500/50 text-blue-400'
                        }`}>
                            <span className="text-lg">${status.type === 'success' ? '‚úÖ' : status.type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                            <span className="font-semibold text-sm">${status.message}</span>
                        </div>
                    `}

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        <!-- Left: Editor -->
                        <div className="lg:col-span-8 space-y-8">
                            
                            <!-- GitHub Settings Panel -->
                            ${showSettings && html`
                                <section className="glass-panel p-6 rounded-3xl animate-in slide-in-from-top-4 duration-300">
                                    <h3 className="text-xl font-bold mb-5 flex items-center gap-2 text-orange-500">
                                        üõ†Ô∏è GitHub Integration
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                                        <div className="col-span-full">
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-widest block mb-2">Personal Access Token</label>
                                            <input 
                                                type="password"
                                                value=${config.token}
                                                onChange=${e => setConfig({...config, token: e.target.value})}
                                                className="w-full bg-black/50 border border-slate-700 p-3 rounded-xl focus:border-orange-500 outline-none transition-all"
                                                placeholder="ghp_..."
                                            />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-widest block mb-2">Owner</label>
                                            <input 
                                                value=${config.owner}
                                                onChange=${e => setConfig({...config, owner: e.target.value})}
                                                className="w-full bg-black/50 border border-slate-700 p-3 rounded-xl focus:border-orange-500 outline-none"
                                                placeholder="e.g. RR-College-Dev"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-widest block mb-2">Repo</label>
                                            <input 
                                                value=${config.repo}
                                                onChange=${e => setConfig({...config, repo: e.target.value})}
                                                className="w-full bg-black/50 border border-slate-700 p-3 rounded-xl focus:border-orange-500 outline-none"
                                                placeholder="e.g. college-website"
                                            />
                                        </div>
                                    </div>
                                    <p className="mt-4 text-xs text-slate-500 italic">Configuration is saved in your browser storage only.</p>
                                </section>
                            `}

                            <!-- Main Editor -->
                            <section className="glass-panel p-8 rounded-3xl shadow-2xl relative">
                                <div className="flex justify-between items-center mb-8">
                                    <h2 className="text-2xl font-bold text-white">Notice Composer</h2>
                                    <div className="flex items-center gap-3">
                                        <span className=${`text-xs font-bold px-3 py-1 rounded-full ${announcement.show ? 'bg-green-900/40 text-green-400' : 'bg-slate-800 text-slate-500'}`}>
                                            ${announcement.show ? '‚óè ACTIVE' : '‚óã HIDDEN'}
                                        </span>
                                        <button 
                                            onClick=${() => setAnnouncement({...announcement, show: !announcement.show})}
                                            className=${`w-14 h-7 rounded-full transition-all relative p-1 ${announcement.show ? 'bg-orange-600' : 'bg-slate-700'}`}
                                        >
                                            <div className=${`w-5 h-5 bg-white rounded-full transition-all ${announcement.show ? 'translate-x-7' : 'translate-x-0'}`}></div>
                                        </button>
                                    </div>
                                </div>

                                <div className="space-y-6">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase tracking-widest block mb-2">Headline</label>
                                        <input 
                                            value=${announcement.title}
                                            onChange=${e => setAnnouncement({...announcement, title: e.target.value})}
                                            className="w-full bg-[#0d1117] border border-slate-700 p-4 rounded-2xl text-lg font-bold text-white focus:border-orange-500 outline-none transition-all placeholder:text-slate-700"
                                            placeholder="e.g. HOLIDAY ANNOUNCEMENT"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase tracking-widest block mb-2">Message Body</label>
                                        <textarea 
                                            value=${announcement.message}
                                            onChange=${e => setAnnouncement({...announcement, message: e.target.value})}
                                            rows="8"
                                            className="w-full bg-[#0d1117] border border-slate-700 p-4 rounded-2xl text-slate-300 leading-relaxed focus:border-orange-500 outline-none transition-all resize-none custom-scrollbar"
                                            placeholder="Enter the notice content here..."
                                        ></textarea>
                                    </div>
                                </div>

                                <button 
                                    onClick=${handleSave}
                                    disabled=${loading || !currentSha}
                                    className="w-full mt-10 py-5 bg-gradient-to-r from-orange-600 to-amber-500 hover:from-orange-500 hover:to-amber-400 text-white font-black text-xl rounded-2xl shadow-2xl shadow-orange-900/30 transition-all active:scale-[0.98] disabled:opacity-20"
                                >
                                    ${loading ? 'PUBLISHING CHANGES...' : 'üöÄ PUSH TO LIVE SITE'}
                                </button>
                                
                                ${!currentSha && html`
                                    <p className="text-center text-xs text-slate-500 mt-4 animate-pulse">Sync with GitHub repository to enable publishing.</p>
                                `}
                            </section>
                        </div>

                        <!-- Right: AI & Preview -->
                        <div className="lg:col-span-4 space-y-8">
                            
                            <!-- AI Polishing -->
                            <section className="glass-panel p-6 rounded-3xl">
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                                    <span className="text-purple-400">‚ú®</span> Gemini AI Polish
                                </h3>
                                <div className="grid grid-cols-2 gap-3">
                                    ${['Professional', 'Exciting', 'Concise', 'Urgent'].map(tone => html`
                                        <button 
                                            key=${tone}
                                            disabled=${isRefining}
                                            onClick=${() => handleAIPolish(tone)}
                                            className="p-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-xs font-bold border border-slate-700 transition-all flex items-center justify-center gap-2 disabled:opacity-50"
                                        >
                                            ${isRefining ? '...' : tone}
                                        </button>
                                    `)}
                                </div>
                                ${isRefining && html`
                                    <div className="mt-4 text-[10px] text-purple-400 text-center uppercase tracking-widest font-black animate-pulse">
                                        AI is crafting your message...
                                    </div>
                                `}
                            </section>

                            <!-- Visual Preview -->
                            <section className="glass-panel p-6 rounded-3xl overflow-hidden">
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-400">
                                    üñºÔ∏è Live Preview
                                </h3>
                                <div className="aspect-[4/5] bg-black rounded-2xl border border-slate-800 p-5 relative flex flex-col items-center justify-center text-center">
                                    ${announcement.show ? html`
                                        <div className="bg-gradient-to-br from-orange-600 to-amber-600 p-6 rounded-3xl shadow-2xl animate-in zoom-in-95 duration-500 w-full">
                                            <div className="text-2xl mb-3">üì¢</div>
                                            <h4 className="text-white font-black text-lg leading-tight uppercase mb-3">
                                                ${announcement.title || 'Draft Notice'}
                                            </h4>
                                            <div className="w-12 h-1 bg-white/30 mx-auto rounded-full mb-4"></div>
                                            <p className="text-white/90 text-sm leading-relaxed line-clamp-6">
                                                ${announcement.message || 'Waiting for message content...'}
                                            </p>
                                        </div>
                                    ` : html`
                                        <div className="text-slate-700 flex flex-col items-center">
                                            <span className="text-4xl mb-3 opacity-20">üôà</span>
                                            <p className="text-xs font-bold uppercase tracking-widest">Notice is Hidden</p>
                                        </div>
                                    `}
                                    <div className="absolute bottom-4 left-0 w-full text-[9px] text-slate-700 font-black uppercase tracking-[0.2em]">
                                        RR College Digital Display
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>

                    <footer className="text-center text-slate-600 text-xs font-medium pb-10">
                        Designed for RR International College ‚Ä¢ Project v2.5.0-Final
                    </footer>
                </div>
            `;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
